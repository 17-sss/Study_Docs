---
date: '2022-02-10'
title: 'ë¼ì´ë¸ŒëŸ¬ë¦¬, í”„ë ˆì„ì›Œí¬ ì—†ì´ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ë§Œë“¤ê¸° (5) - Core: PubSub'
categories: ['Project']
---

# âœ¨ ë¼ì´ë¸ŒëŸ¬ë¦¬, í”„ë ˆì„ì›Œí¬ ì—†ì´ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ë§Œë“¤ê¸° (5)

## Core: Store (Pub/Sub)

<div>
  <h3 style="font-weight: 700">ëª©ì°¨</h3>
  <a href="#pubsub--pub">1. Publisher</a>&nbsp;&nbsp;
  <a href="#pubsub--sub">2. Subscriber</a>&nbsp;&nbsp;
  <hr/>
</div>

<h3 id="pubsub--pub">1. Publisher</h3>

`./core/Store/classes/Publisher.ts`

**1) Types**

```ts
interface RecentChangedKeys<S> {
  prevKeys: (keyof S)[];
  currKeys: (keyof S)[];
  largeKeySet: Set<keyof S>;
}
```

- **`RecentChangedKeys`**  
  **Publisher**ì˜ ìƒíƒœê°€ ì—…ë°ì´íŠ¸ ë  ë•Œ **Publisher**ë¥¼ êµ¬ë…í•˜ê³  ìˆëŠ” Componentë“¤ì´ ì•Œë¦¼ì„ ë°›ê²Œ ë˜ëŠ”ë°,  
  ì´ ë•Œ ì„¸ë¶€ì ìœ¼ë¡œ ì–´ë–¤ ìƒíƒœ(ìƒíƒœ ê°ì²´ì˜ í”„ë¡œí¼í‹°)ê°€ ë°”ë€Œì—ˆëŠ”ì§€ ì²´í¬ í›„ ê¸°ë¡ (í”„ë¡œí¼í‹°ì˜ ì´ë¦„ì„ ì €ì¥í•¨).
  - Component ìƒì„± ì‹œ, ComponentëŠ” **Subscriber** ë¥¼ ê°€ì§€ê³  ìˆìŒ

**2) Class**

```ts
/**
 * [Publisher]
 * - Store ì—­í• ì„ í•˜ëŠ” ê°œì²´ë¥¼ ìƒì„±í•  ë•Œ ì‚¬ìš©
 */
class Publisher<S = any> {
  private _state: S;
  private _prevState: S;
  private _notExec: boolean = false;

  private _recentChangedKeys: RecentChangedKeys<S> = { prevKeys: [], currKeys: [], largeKeySet: new Set() };
  private readonly _observers: Set<Function> = new Set();

  constructor(initState: S, private readonly setStateCallback?: () => void) {
    this._state = initState;
    this._prevState = initState;
  }

  get state() {
    return this._state;
  }

  get recentChangedKeys() {
    return this._recentChangedKeys;
  }

  private set state(newState: S) {
    this._state = { ...newState };
    this.setStateCallback && this.setStateCallback();
    this.updateRecentChangedKeys();

    if (this._notExec) this._notExec = false;
    else this.exec();
  }

  setState(newState: S, options?: { notExec?: boolean }): void {
    if (options && typeof options.notExec !== 'undefined') this._notExec = options.notExec;
    this._prevState = { ...this._state };
    this.state = { ...this._state, ...newState }; // setter stateì—ì„œ í™•ì •
  }

  /**
   * ğŸ§šğŸ» exec
   * - ì´ Publisherì— ë“±ë¡ëœ í•¨ìˆ˜ ì‹¤í–‰ (Subscriberë“¤ì˜ func)
   */
  exec(): void {
    this._observers.forEach((func: Function) => func());
  }

  /**
   * ğŸ§šğŸ» add
   * - ì´ Publisherì— í•¨ìˆ˜ ë“±ë¡ (Subscriberì˜ func)
   */
  add(func: Function): void {
    this._observers.add(func);
  }

  /**
   * ğŸ§šğŸ» clear
   * - ì´ Publisherì— ë“±ë¡ëœ í•¨ìˆ˜ ì œê±° (ë‹¨ì¼)
   */
  remove(func: Function): void {
    this._observers.delete(func);
  }

  /**
   * ğŸ§šğŸ» clear
   * - ì´ Publisherì— ë“±ë¡ëœ í•¨ìˆ˜ ì œê±° (ëª¨ë‘)
   */
  clear(): void {
    this._observers.clear();
  }

  /**
   * ğŸ§šğŸ» clearLargeKeySet
   * - this._recentChangedKeys.largeKeySet ì´ˆê¸°í™”
   */
  clearLargeKeySet() {
    this._recentChangedKeys.largeKeySet.clear();
  }

  /**
   * ğŸ‘¾ updateRecentChangedKeys
   * - this._recentChangedKeys ì—…ë°ì´íŠ¸
   */
  private updateRecentChangedKeys(): void {
    const isInitPublisherState = Object.values(this._recentChangedKeys).every((arrValue) => !arrValue.length);

    if (!isInitPublisherState) this._recentChangedKeys.prevKeys = [...this._recentChangedKeys.currKeys];
    this._recentChangedKeys.currKeys = this.getRecentKeys() ?? [];

    const { largeKeySet, currKeys } = this._recentChangedKeys;
    const keyList = [...largeKeySet, ...currKeys];
    keyList.forEach((v) => this._recentChangedKeys.largeKeySet.add(v));
  }

  /**
   * ğŸ‘¾ getRecentKeys
   * - ìµœê·¼ì— Publisherì˜ stateì—ì„œ ë³€ê²½ëœ keyë“¤ ë°˜í™˜
   */
  private getRecentKeys(): (keyof S)[] | null {
    if (!this._state || !this._prevState) return null;
    const arrState = Object.entries(this._state);
    const arrPrevState = Object.entries(this._prevState);

    const result = [];

    for (let i = 0; i < arrState.length; i++) {
      const [key, value] = arrState[i];
      const [prevKey, prevValue] = arrPrevState[i];
      const isDiff = key === prevKey && JSON.stringify(value) !== JSON.stringify(prevValue);
      if (isDiff) result.push(key as keyof S);
    }

    return result;
  }
}

export default Publisher;
```

> ê° ë©”ì„œë“œì˜ ì„¤ëª…ì€ ì£¼ì„ì„ ì°¸ê³ !

**#** ìƒì„±ëœ Publisherì˜ ì˜ˆì‹œë¥¼ ë³´ê³  ì‹¶ë‹¤ë©´ [ê²Œì‹œíŒ ì•±ì˜ mainPublisher](https://github.com/17-sss/no-lib-App/blob/main/3_app/board/frontend/src/core/Store/mainPublisher.ts) ì°¸ê³   
**# ë™ì‘ ê³¼ì • ìš”ì•½**

- **Publisher**ê°€ ìƒì„±ë  ë•Œ, ì´ˆê¸° `state` ê°’ê³¼  
  `setState()`ê°€ ë™ì‘í–ˆì„ ë•Œ **Publisher**ë¥¼ êµ¬ë…í•˜ëŠ” ì»´í¬ë„ŒíŠ¸ë“¤ì˜ í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ê¸° ì „ì— ì‹¤í–‰í•  `setStateCallback()` ì •ì˜
- ì»´í¬ë„ŒíŠ¸ì—ì„œ **Publisher**ë¥¼ ì—…ë°ì´íŠ¸ í•˜ë ¤ê³  `setState()`ë¥¼ ì‹¤í–‰í•œë‹¤ë©´..
  - `setState()`ì˜ 2ë²ˆì§¸ ì¸ìë¡œ ì „ë‹¬ë˜ëŠ” optionsì˜ notExec ê°’ ì—¬ë¶€ë¥¼ ì²´í¬í•œ í›„ **Publisher**ì˜ `_notExec` ê°’ì„ ì—…ë°ì´íŠ¸
  - ì´ì „ state ê°’ (`_prevState`) ì—…ë°ì´íŠ¸
  - ê°±ì‹ ë  state ê°’ (`_state`) ì—…ë°ì´íŠ¸
    - `setStateCallback()`ê°€ ì •ì˜ë˜ì–´ ìˆë‹¤ë©´ ì‹¤í–‰
    - ìµœê·¼ì— ë³€ê²½ëœ stateì˜ propertyê°€ ë¬´ì—‡ì¸ì§€ ê¸°ë¡í•˜ê¸° ìœ„í•´ `updateRecentChangedKeys()` ì‹¤í–‰
    - ì»´í¬ë„ŒíŠ¸ê°€ **Publisher** ì— ë“±ë¡í•´ë‘” í•¨ìˆ˜ë“¤ì„ ì‹¤í–‰í•˜ëŠ” `exec()` ë©”ì„œë“œ ì‹¤í–‰  
      (`_notExec` ê°’ì´ _true_ ë¼ë©´ ì‹¤í–‰í•˜ì§€ ì•Šê³  _false_ ë¡œ ì´ˆê¸°í™”)

<h3 id="pubsub--sub">2. Subscriber</h3>

`./core/Store/classes/Subscriber.ts`

**1) Class**

```ts
import Publisher from './Publisher';

/**
 * [Subscriber]
 * - ì»´í¬ë„ŒíŠ¸ë‚´ì—ì„œ ìƒì„±í•¨.
 * - Publisherì™€ ë°ì´í„°ë¥¼ ì£¼ê³  ë°›ê¸° ìœ„í•´ ì‚¬ìš©
 */
class Subscriber {
  constructor(public func?: Function) {}

  /**
   * ğŸ§šğŸ» registerFunc
   * - publisherì— Subscriberì˜ func ë“±ë¡
   *  (íŠ¹ì • Publisher êµ¬ë…)
   */
  registerFunc(publisher: Publisher): void {
    if (this.func) publisher.add(this.func);
  }

  /**
   * ğŸ§šğŸ» removeFunc
   * - publisherì— Subscriberì˜ func ì œê±°
   *  (íŠ¹ì • Publisher êµ¬ë… ì·¨ì†Œ)
   */
  removeFunc(publisher: Publisher): void {
    if (this.func) publisher.remove(this.func);
  }
}

export default Subscriber;
```

> ê° ë©”ì„œë“œì˜ ì„¤ëª…ì€ ì£¼ì„ì„ ì°¸ê³ !

**#** **Subscriber**ëŠ” ì»´í¬ë„ŒíŠ¸ì˜ `_subscriber` í”„ë¡œí¼í‹°ì— ì¡´ì¬.

- **Publisher**ë¥¼ êµ¬ë…í•  ì¼ì´ ì—†ë‹¤ë©´ ìƒì„±í•˜ì§€ ì•ŠìŒ. ê·¸ëŸ¬ë¯€ë¡œ ê¸°ë³¸ ê°’ì€ `undefined`ë¡œ ì •ì˜ ë˜ì–´ìˆìŒ
- ìì„¸í•œ ë‚´ìš©ì€ ì»´í¬ë„ŒíŠ¸ì˜ `initSubscriber()`ì™€ `registerSubscriberFunction()` ë©”ì„œë“œ ì°¸ê³ 
  - [ìƒì„± ì˜ˆì‹œ: ê²Œì‹œíŒì˜ MainPageBoard(Compositions)](https://github.com/17-sss/no-lib-App/blob/main/3_app/board/frontend/src/compositions/MainPageBoard/index.ts)
