---
date: '2022-01-31'
title: 'ë¼ì´ë¸ŒëŸ¬ë¦¬, í”„ë ˆì„ì›Œí¬ ì—†ì´ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ë§Œë“¤ê¸° (2) - Core: Component'
categories: ['Project']
---

# âœ¨ ë¼ì´ë¸ŒëŸ¬ë¦¬, í”„ë ˆì„ì›Œí¬ ì—†ì´ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ë§Œë“¤ê¸° (2)

## Core: Component

<div>
  <h3 style="font-weight: 700">ëª©ì°¨</h3>
  <a href="#component--main">1. ë©”ì¸</a>&nbsp;&nbsp;
  <a href="#component--vdom">2. ê°€ìƒë”</a>&nbsp;&nbsp;
  <hr/>
</div>

<h3 id="component--main">1. index.ts (Component - ë©”ì¸)</h3>

`./core/Component/index.ts`

**1) imports**

```ts
import CustomError from '../CustomError';
import { Publisher, Subscriber } from '../Store';
import { makeComponentId } from './functions';
import { createNodes, createTemplateNodes, updateNodes } from './vdom';
```

**2) Types**

```ts
export type TargetType = Element | string | null;
export interface ComponentConstructor<P extends Props = {}> {
  new ($target: TargetType, props?: P): Component;
}

export interface ComponentItemType<P extends Props = {}> {
  Component: ComponentConstructor<P>;
  $target?: TargetType;
  props?: P;
}

const defaultPropsKeys = ['isNotKeepAdding', 'initInsertPosition'] as const;
interface DefaultProps {
  isNotKeepAdding?: boolean;
  initInsertPosition?: InsertPosition;
}
export type Props<P = {}> = P & DefaultProps;

export interface SetStateOptions {
  noRender?: boolean;
  isSetEvents?: boolean;
}

type RenderState = 'default' | 'adding' | 'done' | 'disabled';
```

- **`TargetType`**  
  Componentì˜ HTML(Template)ì´ ë Œë”ë§ ë  ìš”ì†Œ
- **`ComponentConstructor`**  
  new ìƒì„±ìë¡œ Component ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•  ë•Œ ì‚¬ìš©
- **`ComponentItemType`**  
  `ComponentConstructor` íƒ€ì…ì„ ê°€ì§„ ê°ì²´ë¥¼ ìƒì„±í•  ë•Œ ì‚¬ìš©  
  **ì˜ˆì‹œ**
  ```ts
  const spanType: ComponentItemType = {
    Component: Span, // Component í´ë˜ìŠ¤ë¥¼ ìƒì†ë°›ì€ Span í´ë˜ìŠ¤
    $target: '#root', // Span ì»´í¬ë„ŒíŠ¸ì˜ HTML(Template)ì´ ë Œë”ë§ ë  ê¸°ì¤€ ìš”ì†Œ
    props: { text: 'í…ŒìŠ¤íŠ¸' }, // Span ì»´í¬ë„ŒíŠ¸ì— ë“±ë¡ë  props
  };
  const { Component: SpanComponent, $target, props } = spanType;
  new SpanComponent($target, props);
  ```
- **`DefaultProps`**  
  Component í´ë˜ìŠ¤ë¥¼ ìƒì† ë°›ì€ ëª¨ë“  ê°œì²´ê°€ ê¸°ë³¸ì ìœ¼ë¡œ ê°€ì§€ê³ ìˆëŠ” Props
- **`SetStateOptions`**  
  Component í´ë˜ìŠ¤ë‚´ì—ì„œ ê´€ë¦¬í•  ìƒíƒœ ê°’ (`_state`)
- **`RenderState`**  
  Componentë¥¼ ìƒì„±í•  ë•Œ ë“±ë¡ëœ HTML(Template)ì´ ë Œë”ë§í•˜ê³ ì í•˜ëŠ” <u>`$target`ì— ì´ì–´ì„œ ë Œë”ë§í•  ê²ƒì¸ì§€</u>,  
  <u>ê¸°ì¡´ì— ë Œë”ë§ëœ HTMLê³¼ ìƒˆë¡œ ë Œë”ë§ë  HTMLì„ ë¹„êµí•˜ë©° ë Œë”ë§ í•  ê²ƒì¸ì§€</u> ë“±ì˜ ì—¬ë¶€ë¥¼ ë‚˜íƒ€ëƒ„.

**3) Class**

```ts
/**
 * [Component]
 * - ëª¨ë“  ì»´í¬ë„ŒíŠ¸(ì¼ë°˜, page, Link)ì˜ ë¶€ëª¨ê°€ ë˜ëŠ” class
 */
class Component<S = {}, P extends Props = DefaultProps> {
  private _state: S | undefined;
  private _renderState: RenderState = 'adding';
  protected _subscriber: Subscriber | undefined;
  protected readonly componentId: string = makeComponentId();

  constructor(protected readonly $target: TargetType, protected props: P = {} as Props<P>) {
    try {
      if (typeof $target === 'string') this.$target = document.querySelector($target);
      if (this.$target === null) throw new CustomError({ msgType: 'NOT_FOUND_TARGET', name: this.constructor.name });

      this.init();
      this.initSubscriber();
      this.render();
    } catch (e) {
      console.error(e);
    }
  }

  /**
   * âœ¨ init
   * - setStateë¥¼ í™œìš©í•˜ì—¬ ì´ˆê¸° stateë¥¼ ì •í•´ì£¼ëŠ” ë“± ì´ˆê¸°í™”ê°€ í•„ìš”í•œ ì‘ì—…ì´ ìˆì„ ë•Œ ì‚¬ìš©
   */
  protected init(): void {}

  /**
   * âœ¨ initSubscriber
   * - registerSubscriberFunction() ë¥¼ í™œìš©í•  ë•Œ ì‚¬ìš©
   */
  protected initSubscriber(): void {}

  /**
   * âœ¨ registerSubscriberFunction
   * - this._subscriberì— í•¨ìˆ˜ë¥¼ ë“±ë¡í•˜ê³  ì´ í•¨ìˆ˜ë¥¼ publisherì˜ observerì— ë“±ë¡
   * - [!] initSubscriber() ë©”ì„œë“œ ë‚´ì—ì„œ ì‚¬ìš©í•˜ê¸°
   */
  protected registerSubscriberFunction(publisher: Publisher, func: Function): void {
    if (!this._subscriber) this._subscriber = new Subscriber();
    this._subscriber.func = func;
    this._subscriber.registerFunc(publisher);
  }

  /**
   * âœ¨ setState
   * - stateë¥¼ ì •ì˜í•˜ê±°ë‚˜ ì—…ë°ì´íŠ¸í•  ë•Œ ì‚¬ìš©
   */
  protected setState(newState: S, options?: SetStateOptions): void {
    this._state = { ...this._state, ...newState };
    options?.noRender || this.render(options?.isSetEvents ?? true);
  }
  protected get state() {
    return this._state;
  }

  /**
   * âœ¨ setBeforeRender
   * - render í•¨ìˆ˜ ë°”ë¡œ ì§ì „ì— ì‹¤í–‰ë˜ì–´ì•¼ í•  ì‚¬í•­ë“¤ì„ ì„¤ì •
   */
  protected setBeforeRender(): void {}

  /**
   * ğŸ‘¾ render
   * - ì»´í¬ë„ŒíŠ¸ì˜ Templateë¥¼ ìƒì„±í•˜ê³ , props.childrenì— ìˆëŠ” ì»´í¬ë„ŒíŠ¸ë“¤ì„ ìƒì„± í›„ Event ë“±ë¡.
   */
  private render(isSetEvents: boolean = true): void {
    const { $target, props } = this;
    if ($target === null || typeof $target === 'string') return;

    this.setBeforeRender();

    const { isNotKeepAdding, initInsertPosition } = props;
    if (isNotKeepAdding) this._renderState = 'disabled';

    const { _renderState } = this;
    if (_renderState === 'adding') {
      const insertPosition: InsertPosition = initInsertPosition ?? 'beforeend';
      $target.insertAdjacentHTML(insertPosition, this.setTemplate());
      this._renderState = 'done';
    } else this.updateComponentNodes($target, _renderState === 'done');

    this.setChildren();
    isSetEvents && this.setEvents();
  }
  private updateComponentNodes($target: Element, isNeedFixNodes?: boolean) {
    const prevNodes = createNodes($target);
    const newNodes = createTemplateNodes(this.setTemplate());
    updateNodes($target, prevNodes, newNodes, isNeedFixNodes);
  }

  /**
   * âœ¨ setTemplate
   * - ì»´í¬ë„ŒíŠ¸ì˜ Template ì„¤ì •
   */
  protected setTemplate(): string {
    return '';
  }

  /**
   * âœ¨ setChildren
   * - render í›„, ì»´í¬ë„ŒíŠ¸ë¥¼ êµ¬ì„±í•˜ëŠ” ìì‹ ì»´í¬ë„ŒíŠ¸ë¥¼ ë Œë”ë§ í•  ë•Œ ì‚¬ìš©
   */
  protected setChildren(): void {}

  /**
   * âœ¨ setEvents
   * - ì»´í¬ë„ŒíŠ¸ë‚´ì˜ ìš”ì†Œë“¤ì— ì´ë²¤íŠ¸ ì„¤ì •
   */
  protected setEvents(): void {}

  /**
   * âœ¨ getEventTarget
   * - ê° ì»´í¬ë„ŒíŠ¸ì—ì„œ ì´ë²¤íŠ¸ ìƒì„± ì‹œ, ì´ë²¤íŠ¸ê°€ ë“±ë¡ë  Elementë¥¼ ê°€ì ¸ì˜´
   *    - Componentì˜ componentId í”„ë¡œí¼í‹° ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ Elementë¥¼ ê°€ì ¸ì˜´
   *      (ì—†ë‹¤ë©´ í˜„ì¬ ì»´í¬ë„ŒíŠ¸ê°€ ë“±ë¡ëœ this.$target(ë¶€ëª¨)ë¥¼ ê°€ì ¸ì˜´)
   */
  protected getEventTarget(): Element | null {
    let $result = null;
    const { $target, componentId } = this;
    if (!componentId) $result = typeof $target === 'string' ? document.querySelector($target) : $target;
    else $result = document.querySelector(`[data-component-id=${componentId}]`);
    return $result;
  }

  /**
   * âœ¨ createStringAttribute
   * - ì»´í¬ë„ŒíŠ¸ì—ì„œ ë Œë”ë§í•˜ëŠ” templateì— attributeë¥¼ ì¶”ê°€í•  ë•Œ ì‚¬ìš©
   */
  protected createStringAttribute(...excludeStrs: string[]): string {
    const arrExclude = [...defaultPropsKeys, ...excludeStrs];
    const strAttribute = Object.entries(this.props).reduce((result, [key, value]) => {
      if (arrExclude.includes(key)) return result;
      result += `${key}="${value}" `;
      return result;
    }, '');
    return strAttribute;
  }
}

export default Component;
```

> ê° ë©”ì„œë“œì˜ ì„¤ëª…ì€ ì£¼ì„ì„ ì°¸ê³ !

- ìƒì„± ì‹œ ë™ì‘ ê³¼ì • (**ìš”ì•½**)  
  `constructor` -> `init` -> `initSubscriber` -> `render`
- ìƒì„± ì‹œ ë™ì‘ ê³¼ì • (**ìì„¸íˆ**)  
  `constructor` -> `init` -> `initSubscriber` -> `render`  
  [`render` ì„¸ë¶€ ë™ì‘]: `setBeforeRender` -> `setTemplate` or `updateComponentNodes` -> `setChildren` -> `setEvents`
- ë™ì‘ ê³¼ì • ì„œìˆ 
  - `init`ì€ Componentë¥¼ ìƒì†ë°›ì€ ê°ì²´ë“¤ì´ ìƒì„±ë  ë•Œ `init` ë©”ì„œë“œì— ìˆëŠ” ë¡œì§ë“¤ì„ ì²˜ë¦¬í•¨.  
    (`setState`ë¥¼ í†µí•´ ì´ˆê¸° stateë¥¼ ì •ì˜í•´ì£¼ê±°ë‚˜ ë§¨ ì²˜ìŒì— ì²˜ë¦¬í•´ì•¼ í•  ë¡œì§ë“¤ì„ ì‘ì„±)
  - `initSubscriber`ëŠ” Publisher(Store) ì „ì—­ ìƒíƒœê°€ ë³€ê²½ë  ë•Œ ì‹¤í–‰ë  ë©”ì„œë“œ ë¡œì§ì„ ì‘ì„±í•˜ëŠ” ë¶€ë¶„  
    **ì˜ˆì‹œ** (`registerSubscriberFunction` ë©”ì„œë“œë¥¼ í†µí•´ ì²˜ë¦¬í•¨)
    ```ts
    protected initSubscriber(): void {
      // main
      this.registerSubscriberFunction(mainPublisher, () => {
        const { currKeys } = mainPublisher.recentChangedKeys;
        if (currKeys.includes("isInit")) return this.execInitMainPageBoard();
        if (currKeys.includes("filterOptions") || currKeys.includes("postData") || currKeys.includes("isRefresh"))
          this.execUpdateMainPageBoard(currKeys.includes("isRefresh"));
      });
    }
    ```
  - `render`: `setBeforeRender`ëŠ” `render`ë‚´ì—ì„œ ë“±ë¡ëœ Templateë¥¼ ë Œë”ë§í•˜ê¸° ì „ì— ì²˜ë¦¬í•´ì•¼ í•  ë¡œì§ë“¤ì´ ìˆì„ ë•Œ ì‚¬ìš©
  - `render`ë‚´ì—ì„œ `setBeforeRender`ë¥¼ ì‹¤í–‰ í›„, ì´ˆê¸° ë Œë”ë§ ì‹œì—ëŠ” `$target`ì— í˜„ì¬ Componentì˜  
    Template(`setTemplate` ë©”ì„œë“œê°€ ë°˜í™˜) ë¥¼ ì¶”ê°€í•˜ë©° ë Œë”ë§
    - ì´ˆê¸° ë Œë”ë§ í›„ì— "adding" ìƒíƒœì˜€ë˜ `_renderState`ê°€ "done"ìœ¼ë¡œ ë°”ë€Œê³  ì¶”í›„ `setState`ë¥¼ í†µí•´  
       ë‹¤ì‹œ Template ë Œë”ë§ì„ í•  ê²½ìš° `updateComponentNodes` ë©”ì„œë“œë¥¼ ì‹¤í–‰í•˜ì—¬ ì–´ëŠ ìš”ì†Œê°€ ë°”ë€Œì—ˆëŠ”ì§€  
       ì²´í¬ í›„ì— ë‹¤ì‹œ ë Œë”ë§í•¨.
      > ë§Œì•½ì— _isNotKeepAdding_ ì†ì„±ì´ **true** ì¼ ì‹œ ë¬´ì¡°ê±´ `updateComponentNodes`ë¥¼ í†µí•´ ë Œë”ë§í•˜ê²Œ ë¨.
  - ë Œë”ë§ê³¼ ê´€ë ¨ëœ ì‘ì—…ì´ ëë‚¬ë‹¤ë©´ `render` ë©”ì„œë“œì—ì„œì˜ ë§ˆì§€ë§‰ì€, `setChildren`ì™€ `setEvents`ë¥¼ ì‹¤í–‰í•¨
    - `setChildren`ì˜ ê²½ìš° í˜„ì¬ ìƒì„±ë˜ê³  ìˆëŠ” Componentì˜ Templateë¿ë§Œ ì•„ë‹ˆë¼,  
      í˜„ì¬ Component Templateë‚´ì— ì¶”ê°€ì ìœ¼ë¡œ ìì‹ Componentë„ ë Œë”ë§ í•´ì•¼í•  ê²½ìš°ì— ì—¬ê¸°ì•ˆì—ì„œ ìì‹ë“¤ì„ ìƒì„±í•¨
    - `setEvents`ëŠ” Template ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìƒì„±ëœ ì—˜ë¦¬ë¨¼íŠ¸ë“¤ì— Eventë¥¼ ë“±ë¡í•  ë•Œ ì‚¬ìš©

<br/>

<h3 id="component--vdom">2. vdom.ts (Component - ê°€ìƒë” : DIFF ì•Œê³ ë¦¬ì¦˜)</h3>

`./core/Component/vdom.ts`

```ts
/**
 * âœ¨ createNodes
 * - ì£¼ì–´ì§„ Elementì˜ childNodes ë°˜í™˜
 */
export function createNodes(originEle: Element | Node): Node[] {
  return Array.from(originEle.childNodes);
}

/**
 * âœ¨ createTemplateNodes
 * - ì„ì‹œ Elementë¥¼ ìƒì„±í•˜ì—¬ innerHTMLì— strTemplateë¥¼ ëŒ€ì… í›„ childNodesë¥¼ ë°˜í™˜
 */
export function createTemplateNodes(strTemplate: string): Node[] {
  const tempEle = document.createElement('div');
  tempEle.innerHTML = strTemplate;
  return Array.from(tempEle.childNodes);
}

// ------

/**
 * âœ¨ updateNodes
 * - ì´ì „ Nodeë“¤ê³¼ ìƒˆë¡œìš´ Nodeë“¤ì„ ë¹„êµí•˜ì—¬ ìµœì‹ ìœ¼ë¡œ ì—…ë°ì´íŠ¸
 */
export function updateNodes(
  originEle: Element | Node,
  prevNodes: Node[],
  newNodes: Node[],
  isNeedFixNodes?: boolean,
): void {
  const MAX_LENGTH = Math.max(prevNodes.length, newNodes.length);
  let idx = 0;

  if (isNeedFixNodes) newNodes = fixedNewNodes(prevNodes, newNodes);

  while (MAX_LENGTH > idx) {
    const prevNode = prevNodes[idx];
    const newNode = newNodes[idx];

    // 1. ê¸°ë³¸ ë¹„êµ
    const isDfff = execDifferentCheck(originEle, prevNode, newNode);
    if (isDfff) {
      idx++;
      continue;
    }

    // 2. ì†ì„± ë¹„êµ
    execAttributesCheck(prevNode, newNode);

    // 3. ì¬ê·€
    const prevChildren = createNodes(prevNode);
    const newChildren = createNodes(newNode);
    if (prevChildren.length || newChildren.length) updateNodes(prevNode, prevChildren, newChildren);
    idx++;
  }
}

/**
 * ğŸ‘¾ execDifferentCheck
 * - ì´ì „ Nodeì™€ ìƒˆë¡œìš´ Nodeê°€ ë‹¤ë¥¼ ë•Œ ëª¨ë“  ì¡°ê±´ì„ ê³„ì‚°í•˜ê³  ì—…ë°ì´íŠ¸
 *      - ì´ í•¨ìˆ˜ê°€ ë§ˆì§€ë§‰ì— trueë¥¼ ë°˜í™˜í–ˆë‹¤ë©´ attributesë¥¼ ì—…ë°ì´íŠ¸í•  í•„ìš”ëŠ” ì—†ìŒ
 */
function execDifferentCheck(originEle: Element | Node, prevNode: Node, newNode: Node) {
  const isRemove = prevNode && !newNode;
  const isAppend = !prevNode && newNode;

  if (isRemove) originEle.removeChild(prevNode);
  else if (isAppend) originEle.appendChild(newNode);
  if (isRemove || isAppend) return true;

  const isNotSameType = prevNode.nodeName !== newNode.nodeName;
  const isTextType = [prevNode, newNode].every((node) => node instanceof Text);
  const isDiffText = isTextType && prevNode.nodeValue !== newNode.nodeValue;

  if (isNotSameType) originEle.replaceChild(newNode, prevNode);
  else if (isDiffText) prevNode.nodeValue = newNode.nodeValue;
  if (isNotSameType || isDiffText) return true;

  return false;
}

/**
 * ğŸ‘¾ execAttributesCheck
 * - [!] ì¼ë°˜ Node íƒ€ì…ì—ì„œëŠ” ì‚¬ìš© ë¶ˆê°€.
 * - ì´ì „ Elementì˜ attributesë¥¼ ìƒˆë¡œìš´ Elementì˜ attributesë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì—…ë°ì´íŠ¸
 *      - ì—…ë°ì´íŠ¸ í›„, ìƒˆë¡œìš´ Elementì— ì—†ëŠ” ì†ì„±ì´ë¼ë©´ ì œê±°.
 */
function execAttributesCheck(prevNode: Node | Element, newNode: Node | Element) {
  if (!(prevNode instanceof Element) || !(newNode instanceof Element)) return;

  const newAttrs = Array.from(newNode.attributes);
  const prevAttrs = Array.from(prevNode.attributes);
  newAttrs.forEach(
    ({ name, value }) =>
      prevAttrs.find(({ name: prevName, value: prevValue }) => name === prevName && value === prevValue) ??
      prevNode.setAttribute(name, value),
  );
  prevAttrs.forEach(
    ({ name }) => newAttrs.find(({ name: newName }) => newName === name) ?? prevNode.removeAttribute(name),
  );
}

/**
 * ğŸ‘¾ fixedNewNodes
 * - Compoenntì—ì„œ isKeepAddingì— ì˜í•´ _renderState ë³€ê²½ ì‹œ newNodesë§Œ ë¹„êµí•˜ì—¬ ì—…ë°ì´íŠ¸í•˜ë©´ ì•ˆë¨.
 *    - prevNodesì—ëŠ” ë‹¤ë¥¸ ì»´í¬ë„ŒíŠ¸ë“¤ì— ì˜í•´ ì¶”ê°€ëœ Elementë“¤ì´ ìˆìŒ.
 * - ì£¼ì–´ì§„ prevNodes, newNodesë¥¼ í™œìš©í•˜ì—¬ ìƒˆë¡œìš´ nodeë“¤ì„ ë§Œë“¤ì–´ë‚´ëŠ” í•¨ìˆ˜
 *   - prevNodesë¥¼ ë³µì œ í›„, newNodesì˜ ìš”ì†Œë¥¼ ì¶”ê°€í•˜ì—¬ ìƒˆë¡œìš´ nodeë“¤ì„ ë°˜í™˜.
 */
function fixedNewNodes(prevNodes: Node[], newNodes: Node[]): Node[] {
  const result = [...prevNodes];
  newNodes.forEach((newNode) => {
    const idx = prevNodes.findIndex((prevNode) => {
      const isSameNodeName = newNode.nodeName === prevNode.nodeName;
      const isAllElement = prevNode instanceof HTMLElement && newNode instanceof HTMLElement;
      if (!isAllElement) return;
      const prevId = prevNode.dataset.componentId;
      const newId = newNode.dataset.componentId;
      const isSameId = prevId === newId;

      return isSameNodeName && isAllElement && isSameId;
    });
    if (idx === -1) return;
    result[idx] = newNode;
  });
  return result;
}
```

> ê° í•¨ìˆ˜ì˜ ì„¤ëª…ì€ ì£¼ì„ì„ ì°¸ê³ !

- **`fixedNewNodes`?**  
  - ìƒˆë¡œ ì—…ë°ì´íŠ¸ ë  ìš”ì†Œë“¤ì˜ ê°¯ìˆ˜ê°€ í˜„ì¬ ë Œë”ë§ ëœ ìš”ì†Œë³´ë‹¤ í˜„ì €íˆ ì ì€ ê²½ìš°ê°€ ìˆìŒ  
    ë¶€ëª¨ ì»´í¬ë„ŒíŠ¸ì—ì„œ ìì‹ ì»´í¬ë„ŒíŠ¸ë“¤ì„ ë Œë”ë§í•˜ì˜€ê³ , ìì‹ ì»´í¬ë„ŒíŠ¸ì—ì„œ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸ í•  ê²½ìš°  
    **prevNodes**ëŠ” `$target(originEle)`ì˜ ëª¨ë“  ìš”ì†Œì˜ ì •ë³´ë¥¼ ë‹´ê³  ìˆì§€ë§Œ,  
    **newNodes**ëŠ” ìì‹ì˜ Templateë§Œ ê¸°ì¤€ìœ¼ë¡œ í•˜ì—¬ ìƒì„±ë˜ê¸°ì—  
    ì„œë¡œ ë¹„êµë¥¼ í•˜ë©° ì—…ë°ì´íŠ¸í•˜ê²Œ ëœë‹¤ë©´ **newNodes**ë§Œ ê°±ì‹ ë˜ëŠ” í˜„ìƒì´ ìˆì–´ ì´ ë¡œì§ì„ ìƒì„±.